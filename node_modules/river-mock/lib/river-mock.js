/**
 * river-mock
 * @author xuandao.ws<xuandao.ws@taobao.com>
 * @update 2013.04.02
 */

/**
 * 处理正常mockTemplate
 * @name handleObjectMockTemplate
 */
var Mock = require('mockjs');

function handleNormalMockTemplate(schema, undef){
    var dtype = schema['type'],
        def = schema['default'],
        em = schema['enum'],
        ret,
        pattern,
        format,
        color,
        size,
        max,
        min;

    switch(dtype){
        //mock规则:
        case 'string':
        {
            min = schema['minLength'] || undef;
            max = schema['maxLength'] || undef;
            format = schema['format'];
            pattern = schema['pattern'];

            if(format == 'URI'){
                ret = def;
            }
            else if(format == 'email'){
                ret = Mock.Random.email();
            }
            else if(RegExp(/PARAM_PIC_SIZE/).test(format)){
                var size = format.match(/PARAM_PIC_SIZE_(.+)_(.+)/);
                ret = Mock.Random.image(size[1]+'x'+size[2]);
            }else if(format == 'TMALL_DETAIL' || format == 'TAOBAO_DETAIL'){
                //天猫、淘宝detail页
                var isTmall = (format == 'TMALL_DETAIL' ? true : false),
                    itemId = Mock.Random.integer(31397137932, 39397137932),
                    url = (isTmall ? 'http://detail.tmall.com/item.htm?id=' : 'http://detail.taobao.com/item.htm?id=');

                ret = (url + itemId);
            }else if(format == 'TMALL_SHOP' || format == 'TAOBAO_SHOP'){
                //天猫、淘宝shop页
                var isTmall = (format == 'TMALL_SHOP' ? true : false),
                    taobaoID = Mock.Random.integer(71732898, 7273289),
                    tmallId = Mock.Random.string({
                        lower: "abcdefghijklmnopqrstuvwxyz"
                    }, 3,7),
                    url = (isTmall ? ('http://' + tmallId + '.tmall.com') : ('http://shop' + taobaoID + '.taobao.com/shop/view_shop.htm'));

                ret = url;
            }else{
                if(!def){
                    ret = ((min && max) ? Mock.Random.string(min, max) : Mock.Random.string());
                }
            }
            break;
        }
        case 'number':
        case 'integer':
        {
            min = schema['minimum'] || 10000;
            max = schema['maximum'] || 99999;
            if(def){
                ret = def;
            }else if(em){
                var maxl = em.length - 1;
                var emi = Mock.Random.integer(0, maxl);
                ret = em[emi];
            }else{
                ret = Mock.Random.integer(min, max);
            }
            break;
        }
        case 'boolean':
            ret = Mock.Random.boolean();
            break;
    }

    return ret || def;
}

/**
 * 处理object\array mockTemplate
 * @param schema
 * @returns {object}
 */
function handleObjectMockTemplate(schema){
    var properties = schema['properties'],
        type = schema['type'],
        ret, foo, stype, isObj, max, min;

    if(type == 'array'){
        ret = [];
        max = schema['maxItems'] || 1;
        min = schema['minItems'] || 1;
        foo = Mock.Random.integer(min, max);
        for(var i =0; i< foo; i++){
            if(schema['items']['type'] == 'object' || schema['items']['type'] == 'array'){
                ret.push(arguments.callee(schema['items']));
            }else{
                ret.push(handleNormalMockTemplate(schema['items']));
            }
        }
    }else if(type == 'object'){
        ret = {};
        for(var key in properties){
            stype = properties[key]['type'];
            isObj = ((stype == 'object' || stype == 'array') ? true : false);

            ret[key] = isObj ? arguments.callee(properties[key]) :
                handleNormalMockTemplate(properties[key]);
        }
    }

    return ret;
}

/**
 * 处理ResponseMap
 * @name handleResponseMap
 * @param data {json-schema}
 * @param req
 */
function handleResponseMap(data, req){
    var map = data['meta']['responseMap'] || [],
        rules,
        rule,
        ruleprop,
        schema,
        retSchema,
        q = req || {},
        hit = true;

    for(var i = 0; i < map.length; i++){
        rules = map[i]['rule'];
        schema = map[i]['schema'];

        for(var j = 0; j < rules.length; j++){
            rule = rules[j];
            ruleprop = rule['property'];
            switch(rule['type']){
                case 'request':
                {
                    if(schema && ruleprop){
                        if(rule['value']){
                            hit = (q[ruleprop] == rule['value']);
                            if (!hit && rule['pattern']) {
                                hit = new RegExp(rule['pattern']).test(q[ruleprop]);
                            }
                        }else if(rule['pattern']){
                            hit = new RegExp(rule['pattern']).test(q[ruleprop]);
                        }
                    }
                }
                    break;
                case 'response':
                {
                    hit = false;
                }
                    break;
                case 'method':
                {
                    hit = false;
                }
                    break;
                default:
                    hit = false;
            }
        }

        if(hit){
            retSchema = schema;
            break;
        }
    }

    return retSchema || 'response';
}

exports.handleMock = handleObjectMockTemplate;
exports.handleResponseMap = handleResponseMap;
